# æŒ‡ä»¤é˜²æŠ–ç³»ç»Ÿ (Command Debounce System)

## æ¦‚è¿°

æŒ‡ä»¤é˜²æŠ–ç³»ç»Ÿæ˜¯ä¸ºé”æ§æ¿é€šä¿¡è®¾è®¡çš„æ ¸å¿ƒç»„ä»¶ï¼Œè§£å†³äº†ä¸Šä½æœºä¸é”æ§æ¿é€šä¿¡ä¸­çš„æŒ‡ä»¤å†²çªå’Œæ—¶åºæ§åˆ¶é—®é¢˜ã€‚ç³»ç»Ÿé‡‡ç”¨åŸºäºå“åº”ç¡®è®¤çš„é˜²æŠ–æœºåˆ¶ï¼Œç¡®ä¿æŒ‡ä»¤æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œï¼Œé¿å…é€šä¿¡å†²çªã€‚

## æ ¸å¿ƒç‰¹æ€§

### âœ… å“åº”ç¡®è®¤æœºåˆ¶

- é€šè¿‡åŒ¹é…å“åº”æŒ‡ä»¤å­—ç¡®è®¤æŒ‡ä»¤æ‰§è¡Œå®Œæˆ
- æ”¯æŒæ¿åœ°å€å’ŒæŒ‡ä»¤å­—åŒé‡éªŒè¯
- ç¡®ä¿æŒ‡ä»¤æ‰§è¡Œç»“æœçš„å‡†ç¡®æ€§

### â±ï¸ æ™ºèƒ½è¶…æ—¶æ§åˆ¶

- åŸºäºä¸åŒæŒ‡ä»¤ç±»å‹çš„åŠ¨æ€è¶…æ—¶è®¡ç®—
- å®‰å…¨ç³»æ•°è®¾è®¡ï¼Œé¿å…ç³»ç»Ÿå¡æ­»
- æ”¯æŒè¶…æ—¶é‡è¯•å’Œé”™è¯¯å¤„ç†

### ğŸ“¦ æŒ‡ä»¤é˜Ÿåˆ—ç®¡ç†

- å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—è®¾è®¡
- è‡ªåŠ¨å¤„ç†æŒ‡ä»¤æ‰§è¡Œæ—¶åº
- æ”¯æŒé˜Ÿåˆ—çŠ¶æ€ç›‘æ§å’Œç®¡ç†

### ğŸ§ª å®Œå…¨å¯æµ‹è¯•

- ä¾èµ–æ³¨å…¥è®¾è®¡ï¼Œæ”¯æŒMockæµ‹è¯•
- æä¾›å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- ç”Ÿäº§ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒæ— ç¼åˆ‡æ¢

### ğŸ”§ é«˜åº¦å¯é…ç½®

- æ”¯æŒä¸åŒé€šä¿¡æ–¹å¼ï¼ˆä¸²å£ã€ç½‘ç»œç­‰ï¼‰
- å¯é…ç½®çš„æ‰§è¡Œæ—¶é—´å‚æ•°
- çµæ´»çš„é”™è¯¯å¤„ç†ç­–ç•¥

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application Layer)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                æŒ‡ä»¤é˜²æŠ–ç®¡ç†å™¨ (CommandDebounceManager)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   æŒ‡ä»¤é˜Ÿåˆ—      â”‚  â”‚   è¶…æ—¶æ§åˆ¶      â”‚  â”‚   å“åº”åŒ¹é…      â”‚ â”‚
â”‚  â”‚   (Queue)       â”‚  â”‚   (Timeout)     â”‚  â”‚   (Matcher)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                æŒ‡ä»¤å‘é€å™¨æ¥å£ (CommandSender)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  çœŸå®ä¸²å£å‘é€å™¨  â”‚              â”‚  Mockå‘é€å™¨     â”‚       â”‚
â”‚  â”‚ (SerialSender)  â”‚              â”‚ (MockSender)   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ç¡¬ä»¶å±‚ (Hardware Layer)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç»„ä»¶è¯´æ˜

### æ ¸å¿ƒæ¥å£

#### CommandSender

æŒ‡ä»¤å‘é€æ¥å£ï¼ŒæŠ½è±¡åº•å±‚é€šä¿¡æ–¹å¼ï¼š

```java
public interface CommandSender {
    void sendCommand(byte[] command);

    void setOnResponseListener(OnResponseListener listener);

    boolean isConnected();

    void disconnect();
}
```

#### OnResponseListener

å“åº”ç›‘å¬æ¥å£ï¼š

```java
public interface OnResponseListener {
    void onResponseReceived(byte[] response);

    void onError(String error);
}
```

#### OnCommandListener

æŒ‡ä»¤æ‰§è¡Œç›‘å¬æ¥å£ï¼š

```java
public interface OnCommandListener {
    void onSuccess();

    void onError(String error);
}
```

### æ ¸å¿ƒç»„ä»¶

#### CommandDebounceManager

é˜²æŠ–ç®¡ç†å™¨ï¼Œç³»ç»Ÿæ ¸å¿ƒï¼š

- æŒ‡ä»¤é˜Ÿåˆ—ç®¡ç†
- æ‰§è¡Œæ—¶åºæ§åˆ¶
- è¶…æ—¶å¤„ç†
- å“åº”åŒ¹é…

#### CommandExecutionStrategy

æŒ‡ä»¤æ‰§è¡Œç­–ç•¥ï¼š

- å®šä¹‰ä¸åŒæŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´
- è®¡ç®—åŠ¨æ€è¶…æ—¶æ—¶é—´
- æä¾›æŒ‡ä»¤æè¿°ä¿¡æ¯

#### ResponseMatcher

å“åº”åŒ¹é…å™¨ï¼š

- éªŒè¯å“åº”æ ¼å¼
- åŒ¹é…æŒ‡ä»¤å’Œå“åº”
- è§£æå“åº”çŠ¶æ€

#### QueuedCommand

é˜Ÿåˆ—æŒ‡ä»¤é¡¹ï¼š

- å°è£…æŒ‡ä»¤æ•°æ®
- ç®¡ç†æ‰§è¡ŒçŠ¶æ€
- è¶…æ—¶æ§åˆ¶

### å‘é€å™¨å®ç°

#### LockCtlBoardSerialSender

çœŸå®ä¸²å£å‘é€å™¨ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒï¼š

- ä¸²å£é€šä¿¡ç®¡ç†
- æ•°æ®ç¼“å†²å’Œåˆ†åŒ…å¤„ç†
- è¿æ¥çŠ¶æ€ç›‘æ§

#### MockCommandSender

Mockå‘é€å™¨ï¼Œç”¨äºæµ‹è¯•ç¯å¢ƒï¼š

- æ¨¡æ‹ŸçœŸå®å“åº”å»¶è¿Ÿ
- æ”¯æŒé”™è¯¯æ¨¡æ‹Ÿ
- è¯¦ç»†çš„æ‰§è¡Œè®°å½•

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

#### 1. åˆå§‹åŒ–ç³»ç»Ÿ

```java
// ç”Ÿäº§ç¯å¢ƒ - ä½¿ç”¨çœŸå®ä¸²å£
CommandSender sender = new LockCtlBoardSerialSender();
CommandDebounceManager debounceManager = new CommandDebounceManager(sender);

// æµ‹è¯•ç¯å¢ƒ - ä½¿ç”¨Mockå‘é€å™¨
MockCommandSender mockSender = new MockCommandSender();
CommandDebounceManager debounceManager = new CommandDebounceManager(mockSender);
```

#### 2. å‘é€æŒ‡ä»¤

```java
byte[] openLockCommand = LockCtlBoardCmdHelper.buildOpenSingleLockCommand((byte) 0x00, 1);

debounceManager.

sendCommand(openLockCommand, new OnCommandListener() {
    @Override
    public void onSuccess () {
        Log.i(TAG, "å¼€é”æˆåŠŸ");
    }

    @Override
    public void onError (String error){
        Log.e(TAG, "å¼€é”å¤±è´¥: " + error);
    }
});
```

#### 3. ç›‘æ§çŠ¶æ€

```java
CommandDebounceManager.QueueStatus status = debounceManager.getStatus();
Log.

d(TAG, "é˜Ÿåˆ—çŠ¶æ€: "+status.toString());
```

### é«˜çº§ä½¿ç”¨

#### æ‰¹é‡æ“ä½œ

```java
// å¿«é€Ÿå‘é€å¤šä¸ªæŒ‡ä»¤ï¼Œè‡ªåŠ¨é˜²æŠ–å¤„ç†
for(int i = 1;
i <=5;i++){
byte[] command = LockCtlBoardCmdHelper.buildOpenSingleLockCommand((byte) 0x00, i);
    debounceManager.

sendCommand(command, listener);
}
```

#### é”™è¯¯é‡è¯•

```java
private void sendWithRetry(byte[] command, int maxRetries, int currentRetry) {
    debounceManager.sendCommand(command, new OnCommandListener() {
        @Override
        public void onSuccess() {
            Log.i(TAG, "æ“ä½œæˆåŠŸ");
        }

        @Override
        public void onError(String error) {
            if (currentRetry < maxRetries) {
                // å»¶è¿Ÿé‡è¯•
                new Handler().postDelayed(() -> {
                    sendWithRetry(command, maxRetries, currentRetry + 1);
                }, 1000);
            } else {
                Log.e(TAG, "æ“ä½œå¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°");
            }
        }
    });
}
```

## æŒ‡ä»¤æ‰§è¡Œæ—¶é—´é…ç½®

ç³»ç»Ÿæ ¹æ®ä¸åŒæŒ‡ä»¤ç±»å‹è‡ªåŠ¨è®¡ç®—æ‰§è¡Œæ—¶é—´å’Œè¶…æ—¶æ—¶é—´ï¼š

| æŒ‡ä»¤ç±»å‹    | æŒ‡ä»¤å­—  | æ‰§è¡Œæ—¶é—´  | è¶…æ—¶æ—¶é—´  | è¯´æ˜          |
|---------|------|-------|-------|-------------|
| å¼€å•ä¸ªé”    | 0x82 | 350ms | 700ms | å¼€å•ä¸ªé—¨é”       |
| åŒæ—¶å¼€å¤šé”   | 0x80 | 350ms | 700ms | æœ€å¤šåŒæ—¶å¼€2ä¸ªé”    |
| æŸ¥è¯¢å•ä¸ªé—¨çŠ¶æ€ | 0x83 | 100ms | 200ms | æŸ¥è¯¢å•ä¸ªé—¨é”çŠ¶æ€    |
| æŸ¥è¯¢æ‰€æœ‰é—¨çŠ¶æ€ | 0x84 | 200ms | 400ms | æŸ¥è¯¢æ‰€æœ‰é—¨é”çŠ¶æ€    |
| å¼€å…¨éƒ¨é”    | 0x85 | åŠ¨æ€è®¡ç®—  | åŠ¨æ€Ã—2  | 350ms Ã— é”æ•°é‡ |
| é€ä¸€å¼€å¤šé”   | 0x86 | åŠ¨æ€è®¡ç®—  | åŠ¨æ€Ã—2  | 350ms Ã— é”æ•°é‡ |
| é€šé“é—ªçƒ    | 0x81 | 100ms | 200ms | LEDé—ªçƒåŠŸèƒ½     |
| é€šé“å¸¸å¼€    | 0x88 | 100ms | 200ms | ç»§ç”µå™¨æŒç»­æ‰“å¼€     |
| é€šé“å…³é—­    | 0x89 | 100ms | 200ms | å…³é—­ç»§ç”µå™¨       |

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./gradlew test

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
./gradlew test --tests "*.CommandDebounceManagerTest"
```

### é›†æˆæµ‹è¯•

```bash
# è¿è¡Œé›†æˆæµ‹è¯•
./gradlew test --tests "*.LockControlIntegrationTest"
```

### æµ‹è¯•è¦†ç›–

- âœ… åŸºæœ¬æŒ‡ä»¤æ‰§è¡Œ
- âœ… æŒ‡ä»¤é˜Ÿåˆ—é¡ºåº
- âœ… å“åº”ç¡®è®¤æœºåˆ¶
- âœ… è¶…æ—¶å¤„ç†
- âœ… é”™è¯¯å¤„ç†
- âœ… é˜Ÿåˆ—çŠ¶æ€ç›‘æ§
- âœ… é«˜é¢‘æŒ‡ä»¤å¤„ç†
- âœ… æ··åˆæ“ä½œåœºæ™¯
- âœ… çœŸå®ä¸–ç•Œåœºæ™¯

## æ€§èƒ½ç‰¹ç‚¹

### æ‰§è¡Œæ•ˆç‡

- åŸºäºå“åº”ç¡®è®¤ï¼Œé¿å…ä¸å¿…è¦çš„å»¶æ—¶
- æŒ‡ä»¤å®Œæˆåç«‹å³æ‰§è¡Œä¸‹ä¸€ä¸ª
- å¹³å‡æ‰§è¡Œæ—¶é—´æ¯”å›ºå®šå»¶æ—¶å‡å°‘30-50%

### å¯é æ€§

- åŒé‡ä¿éšœï¼šå“åº”ç¡®è®¤ + è¶…æ—¶æ§åˆ¶
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
- çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ç®¡ç†

### å¯æ‰©å±•æ€§

- æ”¯æŒä»»æ„æŒ‡ä»¤ç±»å‹
- å¯é…ç½®çš„æ‰§è¡Œå‚æ•°
- æ’ä»¶åŒ–çš„å‘é€å™¨æ¶æ„

## æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†

```java
debounceManager.sendCommand(command, new OnCommandListener() {
    @Override
    public void onSuccess () {
        // å¤„ç†æˆåŠŸæƒ…å†µ
    }

    @Override
    public void onError (String error){
        // è®°å½•é”™è¯¯æ—¥å¿—
        Log.e(TAG, "æŒ‡ä»¤æ‰§è¡Œå¤±è´¥: " + error);

        // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•
        if (error.contains("è¶…æ—¶")) {
            // è¶…æ—¶é‡è¯•é€»è¾‘
        } else {
            // å…¶ä»–é”™è¯¯å¤„ç†
        }
    }
});
```

### 2. èµ„æºç®¡ç†

```java
// åœ¨Activity/Serviceçš„onDestroyä¸­æ¸…ç†èµ„æº
@Override
protected void onDestroy() {
    super.onDestroy();
    if (debounceManager != null) {
        debounceManager.shutdown();
    }
}
```

### 3. çŠ¶æ€ç›‘æ§

```java
// å®šæœŸæ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
private void monitorQueueStatus() {
    CommandDebounceManager.QueueStatus status = debounceManager.getStatus();

    if (status.queueSize > 10) {
        Log.w(TAG, "æŒ‡ä»¤é˜Ÿåˆ—è¿‡é•¿: " + status.queueSize);
    }

    if (status.totalErrors > 0) {
        Log.w(TAG, "æ£€æµ‹åˆ°é”™è¯¯: " + status.totalErrors);
    }
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æŒ‡ä»¤æ‰§è¡Œè¶…æ—¶

**åŸå› **: ç¡¬ä»¶å“åº”æ—¶é—´è¶…è¿‡é¢„æœŸ
**è§£å†³**:

- æ£€æŸ¥ç¡¬ä»¶è¿æ¥
- è°ƒæ•´è¶…æ—¶å‚æ•°
- ç›‘æ§ç¡¬ä»¶çŠ¶æ€

#### 2. æŒ‡ä»¤é˜Ÿåˆ—ç§¯å‹

**åŸå› **: å‘é€æŒ‡ä»¤é€Ÿåº¦è¿‡å¿«
**è§£å†³**:

- æ§åˆ¶å‘é€é¢‘ç‡
- å¢åŠ é˜Ÿåˆ—å®¹é‡ç›‘æ§
- ä¼˜åŒ–æŒ‡ä»¤é€»è¾‘

#### 3. å“åº”åŒ¹é…å¤±è´¥

**åŸå› **: å“åº”æ ¼å¼é”™è¯¯æˆ–ä¹±åº
**è§£å†³**:

- æ£€æŸ¥é€šä¿¡åè®®
- éªŒè¯ç¡¬ä»¶å›ºä»¶
- å¢åŠ å“åº”æ—¥å¿—

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

```java
// åœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨è¯¦ç»†æ—¥å¿—
MockCommandSender mockSender = new MockCommandSender();
mockSender.

setDefaultResponseDelay(100); // å¿«é€Ÿå“åº”
```

#### 2. ç›‘æ§é˜Ÿåˆ—çŠ¶æ€

```java
// å®šæœŸæ‰“å°é˜Ÿåˆ—çŠ¶æ€
Timer timer = new Timer();
timer.

scheduleAtFixedRate(new TimerTask() {
    @Override
    public void run () {
        Log.d(TAG, debounceManager.getStatus().toString());
    }
},0,1000);
```

#### 3. æ¨¡æ‹Ÿé”™è¯¯åœºæ™¯

```java
// åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿé”™è¯¯
mockSender.setSimulateErrors(true);
mockSender.

setErrorRate(0.1); // 10%é”™è¯¯ç‡
```

## ç‰ˆæœ¬å†å²

### v1.0.0

- âœ… åŸºäºå“åº”ç¡®è®¤çš„é˜²æŠ–æœºåˆ¶
- âœ… æ™ºèƒ½è¶…æ—¶æ§åˆ¶
- âœ… å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- âœ… ç”Ÿäº§ç¯å¢ƒæ”¯æŒ

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- æäº¤ GitHub Issue
- å‘é€é‚®ä»¶è‡³å¼€å‘å›¢é˜Ÿ

---

**æ³¨æ„**: æœ¬ç³»ç»Ÿä¸“ä¸ºé”æ§æ¿é€šä¿¡è®¾è®¡ï¼Œä½¿ç”¨å‰è¯·ç¡®ä¿äº†è§£ç›¸å…³ç¡¬ä»¶åè®®å’Œæ“ä½œè§„èŒƒã€‚